<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.4.0 -->
    <script>window.materialVersion = "1.4.0"</script>

    <!-- Title -->
    
    <title>
        
            Android插件化加载原理 | 
        
        Kelton Chan
    </title>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    
    
    
    
    

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="Kelton Chan">
    <meta name="description" itemprop="description" content="I’ve got a long way to go, that’s why I mark down so many notes.">
    <meta name="keywords" content="null,hook,class loader,plugin">

    <!-- Site Verification -->
    
    

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/owl.png">
    <link rel="icon" sizes="192x192" href="/img/owl.png">
    <link rel="apple-touch-icon" href="/img/owl.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Kelton Chan">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://channagihong.github.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Android插件化加载原理 | Kelton Chan">
    <meta property="og:image" content="/img/owl.png" />
    <meta property="og:description" content="I’ve got a long way to go, that’s why I mark down so many notes.">
    <meta property="og:article:tag" content="hook"> <meta property="og:article:tag" content="class loader"> <meta property="og:article:tag" content="plugin"> 

    
        <meta property="article:published_time" content="6月 18, 2017" />
        <meta property="article:modified_time" content="6月 18, 2017" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="Android插件化加载原理 | Kelton Chan">
    <meta name="twitter:description" content="I’ve got a long way to go, that’s why I mark down so many notes.">
    <meta name="twitter:image" content="/img/owl.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://channagihong.github.com" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="https://channagihong.github.com/2017/06/18/Android插件化加载原理/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Kelton Chan",
        "logo": "/img/owl.png"
    },
    "author": {
        "@type": "Person",
        "name": "Kelton Chan",
        "image": {
            "@type": "ImageObject",
            "url": "/img/owl.png"
        },
        "description": "Long way to go."
    },
    "headline": "Android插件化加载原理",
    "url": "https://channagihong.github.com/2017/06/18/Android插件化加载原理/index.html",
    "datePublished": "6月 18, 2017",
    "dateModified": "6月 18, 2017",
    "description": "I’ve got a long way to go, that’s why I mark down so many notes.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://channagihong.github.com"
    }
}
</script>


    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+materialVersion+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(data&&data.indexOf(versionString)===-1){lsloader.removeLS(key)}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload){cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}code=code.split(versionString)[1];if(/\.js?.+$/.test(versionNumber)){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload)}};lsloader.requestResource=function(name,path,cssonload){var that=this;if(/\.js?.+$/.test(path)){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else if(/\.css?.+$/.test(path)){this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import CSS & jQuery -->
    
        <style id="css/material.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        <style id="css/style.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/style.min.css","/css/style.min.css?oCSEO3ST+aEypEwttTDI9g==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        
        
            <style>
    
    .footer-sns-facebook {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHptNjU3LjYgODcuOGw0LjggMy44djU1LjJjMCA1NC42IDAgNTUuMi00LjYgNTkuNi00LjQgNC40LTYgNC42LTUwLjIgNS42bC00NS42IDEtNy4yIDUuNmMtMTAuNCA4LTE2LjggMTcuMi0xOS4yIDI3LjQtMSA1LTEuOCAyNC44LTEuOCA0NCAuMiAzOCAxLjYgNDQuNiAxMC44IDQ4IDIuOCAxLjIgMjguNCAyIDU2LjggMiA0Ny44IDAgNTIgLjIgNTYuMiAzLjhsNC44IDMuOHY1NS4yYzAgNTQuNiAwIDU1LjItNC42IDU5LjYtNC40IDQuNi01LjQgNC42LTU3IDUuMi0yOC44LjItNTQuNC44LTU2LjggMS40LTIuNC42LTUuNiAzLTYuOCA1LjQtMS44IDMuMi0yLjQgNDEuNC0yLjYgMTQzLjJsLS4yIDEzOC44LTUuNiA0LjgtNS42IDQuOEg2MDljLTUyLjQgMC01Mi44IDAtNTguMi00LjZsLTUuNC00LjYtLjItMTQwLjYtLjItMTQwLjYtNC44LTMuOGMtNC4yLTMuNC04LTMuOC0zNS42LTMuOC0zMi44IDAtNDEtMS44LTQzLjYtMTAtLjYtMi4yLTEuMi0yNS40LTEuMi01MS40IDAtNjAuOC0uMi01NyAzLjQtNjEuNiAyLjgtMy42IDYtNCAzNy44LTUgMzMtMSAzNS4yLTEuMiAzOS40LTUuNiA0LjYtNC40IDQuNi01LjIgNS44LTcxIDEuMi03My40LjItNjcuMiAxNi42LTk5LjQgOC0xNS44IDEyLjgtMjIgMjgtMzcgMTUuMi0xNS4yIDIxLjQtMTkuNiAzOC4yLTI4IDExLTUuNCAyNC0xMSAyOS0xMi4yIDYuMi0xLjggMjguNi0yLjYgNzEuMi0yLjYgNTguNi0uMiA2Mi42IDAgNjcgMy42eiIvPjwvc3ZnPg==);
    }
    
    
    .footer-sns-twitter {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHptNTMyLjggMjA1YzEwIDQgMjMgMTAuOCAyOC44IDE1LjIgMTIuNiA5LjIgMTYuNiAxMC42IDI5LjQgOS40IDYuNi0uNiAxMy0zLjIgMjAuNC04LjIgMTEuMi03LjYgMTkuNC05LjIgMjMuNi01IDMuNiAzLjYgMi44IDktMi44IDE4LjYtNy4yIDEyLjQtNiAxOC44IDQuMiAyNC4yIDQuNCAyLjIgOC4yIDUuNiA4LjYgNy40IDEgNC44LTEyLjYgMjQuMi0yMiAzMS44LTExLjggOS4yLTE3LjIgMjIuNi0xOS42IDQ3LjgtNC44IDUwLjQtNy44IDY2LjYtMTYuNCA4NS40LTMgNy03IDE3LjgtOC44IDI0LTEuOCA2LjQtNSAxNC42LTcuNCAxOC40LTIuMiAzLjgtNy40IDEzLTExLjQgMjAuNC0xNy4yIDMwLjgtNDMuNCA2MS40LTcxLjQgODMuOC0yNS42IDIwLjQtNDYgMzMuMi02NC4yIDQwLjItOC40IDMuMi0xOCA3LjYtMjEuNCA5LjYtNy40IDQuNi0yMi40IDguNi01Ny4yIDE1LTYyLjIgMTEuNi03OS4yIDExLjQtMTM1LjYtMS0zMi40LTctMzguNi05LTUyLTE2LjgtMjEuNC0xMi42LTI0LjItMTQuOC0yNC4yLTE5LjQgMC02LjIgMTAuMi05LjIgMzUtMTAuNCAyMi40LTEgMjguNi0yLjYgNTctMTQuMiAyMy44LTkuOCAyOS40LTEyLjggMzAuNC0xNi44IDIuMi04LjItMy0xMy4yLTI2LjgtMjUuNC0yNS44LTEzLjItMzIuMi0xOC40LTQzLjgtMzUuOC05LTEzLjYtMTAtMjEuMi0zLjYtMzMuNiA1LjQtMTAuOCAzLjYtMTUtMTEuOC0yNS40LTktNi0xNC0xMS42LTIwLjgtMjIuNi0yMy40LTM3LjgtMjUtNTAuOC03LjItNTkuOCA0LjgtMi40IDkuNC01LjQgMTAuMi02LjYgMi44LTQuMi0uNC0xNS42LTguNC0yOS0xMS42LTE5LjYtMTMuMi0yNS44LTEzLjItNTUuMiAwLTI4LjggMi42LTM3LjggMTItNDAuMiA5LTIuMiAxNC44IDEgMzUuNiAyMC4yIDI0LjggMjIuOCA0My42IDM2LjYgNjIuOCA0NS44IDggMy44IDE3LjggOS4yIDIyIDEyIDQuMiAyLjggMTQuOCA3IDIzLjQgOS4yIDguNiAyLjIgMjQuMiA2LjggMzQuOCAxMC4yIDEzLjQgNC40IDIzLjYgNi40IDMzIDYuNiAxMi44LjIgMTQuMi0uMiAxOC42LTUuNCA0LTQuOCA0LjgtNy44IDQuOC0xOS4yIDAtMTQuNCA1LjYtMzkuNiAxMS4yLTUwLjYgNC4yLTguNCAyOS4yLTM0LjIgMzkuOC00MS40IDcuOC01LjQgMzUuNi0xNiA1Mi0yMCAxNC4yLTMuNiAzMi42LTEuMiA1Mi40IDYuOHoiLz48L3N2Zz4=);
    }
    
    
    .footer-sns-gplus {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHpNNDMwIDI5NS40YzQwLjYgMTUuNCA1Ni42IDIzLjggNzIuNiAzOC40IDYuOCA2LjIgNy4yIDE1LjIgMSAyMy40LTYuMiA4LTMzLjYgMzMuOC0zOSAzNi42LTUuNiAyLjgtMTcuNiAyLjgtMjMuMi0uMi0yLjQtMS4yLTguMi01LjItMTMtOC44LTExLjItOC42LTI0LjYtMTEuMi01NS4yLTExLjItMjcuNCAwLTQwLjYgMi42LTUyLjIgMTAuNC00LjQgMi44LTEyLjIgNy42LTE3LjIgMTAuNi0yMyAxMy4yLTUxLjQgNTUtNTUuOCA4Mi40LTIuNiAxNS42LTIuNCAzNC44LjIgNTEgMi44IDE3LjQgMTkuOCA0OC44IDM1LjIgNjUuMiAxNiAxNi42IDQ1IDMzLjYgNjIuOCAzNi42IDI2LjggNC40IDY1LjggMS42IDc5LjQtNS44IDIwLjYtMTEuNCAzMS0xOSA0MS0zMC40IDE4LjgtMjEuNiAyMy40LTM0LjIgMTUuNi00My44LTMuOC00LjgtNC40LTQuOC01MS01LjgtNjAuOC0xLjItNTYuMiAyLjItNTYuMi00My4yIDAtMzIuNC4yLTMzLjIgNC44LTM3IDQuNC0zLjYgOS0zLjggOTItMy44IDc5IDAgODcuOC40IDk0LjIgMy42IDExLjIgNS42IDEzIDExLjQgMTIuOCA0My40IDAgMjUuNC0uOCAzMC44LTcuNiA1OC00IDE2LjYtOS44IDM0LTEyLjYgMzktMi44IDUtOC4yIDE0LjItMTEuNiAyMC42LTguNCAxNS40LTI3LjIgMzYuOC00MC44IDQ2LjYtNS44IDQuNC0xMy44IDEwLjItMTcuNiAxMy4yLTMuOCAzLTExIDctMTYuMiA4LjgtNS4yIDEuOC0xNi4yIDYuNC0yNC40IDEwLTIyLjQgOS42LTM0LjggMTEuNi03MyAxMS42LTM3LjYuMi00Ny0xLjQtNzEtMTItOC4yLTMuNi0xNy42LTcuMi0yMC44LTgtMTUuOC0zLjgtNjctNDUuMi03Ny44LTYyLjgtMi4yLTMuOC03LjYtMTEuNi0xMS44LTE3LjItNC4yLTUuNC05LTE0LTEwLjYtMTktMS44LTQuOC02LjItMTYtMTAtMjQuOC0zLjYtOC44LTcuOC0yMi4yLTkuMi0yOS42LTMuMi0xOC44LTEuNC03OS40IDIuOC05MS40IDEzLjgtNDAuNiAzNS42LTc4IDU4LjgtMTAwLjIgMTQtMTMuNiA0Ny4yLTM2LjQgNTgtMzkuOCA0LjItMS40IDEzLjQtNS4yIDIwLjYtOC40IDIyLTEwIDMyLjgtMTEuNiA3Ni0xMSAzMy44LjYgNDAuNCAxLjIgNTAgNC44em0zNDAuOCA4MC44YzggMy42IDkuNiAxMS4yIDkuMiAzOS4yLS42IDM0LjQtLjYgMzQgNSAzOS42IDQuOCA1IDUuNCA1IDM3LjYgNSA0My40IDAgNDQuNC44IDQzLjIgMzYuMi0uOCAxNy0xLjIgMTguNC02LjQgMjMtNS40IDQuNi02LjYgNC44LTM3LjYgNC44LTMxLjIgMC0zMiAuMi0zNi44IDUtNS42IDUuNC01LjYgNC40LTUgNDEuMi40IDI2LjQuMiAyNy40LTQuNiAzMy00LjggNS42LTYgNS44LTI0LjQgNi40LTIwLjguOC0yOS42LTEuNC0zMy40LTguNC0xLjQtMi42LTItMTUuNi0xLjgtMzUuNi40LTMxLjIuNC0zMS42LTQuNi0zNi42cy01LjYtNS0zNi01Yy0xOC44IDAtMzMtLjgtMzYtMi4yLTcuNi0zLjYtOS42LTExLjItOC44LTMzLjguOC0yOC4yLjQtMjggNDEtMjggNDUuNCAwIDQ1LjQgMCA0NC42LTQyLjYtLjYtMzMtLjYtMzMgNS0zOC40IDQuNC00LjYgNi4yLTUgMjQuOC01IDExIDAgMjIuMiAxIDI1IDIuMnoiLz48L3N2Zz4=);
    }
    
    
    
    
    
    
    
    
    
</style>

        
        <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">


        <script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==")</script>
    
    
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Analytics -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    
    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#创建Activity类对象的过程"><span class="post-toc-number">1.</span> <span class="post-toc-text">创建Activity类对象的过程</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ClassLoader机制"><span class="post-toc-number">2.</span> <span class="post-toc-text">ClassLoader机制</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1、class-to-java"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1、class to java</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2、on-RunTime"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2、on RunTime</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3、高度灵活性，如执行刚从网络加载的一个二进制流转换过来的java代码"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">3、高度灵活性，如执行刚从网络加载的一个二进制流转换过来的java代码</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#插件化方案"><span class="post-toc-number">3.</span> <span class="post-toc-text">插件化方案</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ClassLoader入手"><span class="post-toc-number">4.</span> <span class="post-toc-text">ClassLoader入手</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#LoadedApk"><span class="post-toc-number">5.</span> <span class="post-toc-text">LoadedApk</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#解决了从r-packageInfo再到getClassLoader-的问题，理论上就可以加载插件的代码了"><span class="post-toc-number">6.</span> <span class="post-toc-text">解决了从r.packageInfo再到getClassLoader()的问题，理论上就可以加载插件的代码了</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#从performLaunchActivity上溯，辗转到handleLaunchActivity-case-LAUNCH-ACTIVITY，找到r-packageInfo的来源："><span class="post-toc-number">6.1.</span> <span class="post-toc-text">从performLaunchActivity上溯，辗转到handleLaunchActivity, case LAUNCH_ACTIVITY，找到r.packageInfo的来源：</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#goto-getPackageInfoNoCheck"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">goto getPackageInfoNoCheck</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#goto-getPackageInfo"><span class="post-toc-number">7.</span> <span class="post-toc-text">goto getPackageInfo</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#由此可见，可有两个方案"><span class="post-toc-number">8.</span> <span class="post-toc-text">由此可见，可有两个方案</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#激进方案"><span class="post-toc-number">8.0.1.</span> <span class="post-toc-text">激进方案</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#保守方案"><span class="post-toc-number">8.0.2.</span> <span class="post-toc-text">保守方案</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#激进方案，通过LoadedApk放进缓存中，插件中的actiivty对象就能被创建了"><span class="post-toc-number"></span> <span class="post-toc-text">激进方案，通过LoadedApk放进缓存中，插件中的actiivty对象就能被创建了</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#获取mPackages对象"><span class="post-toc-number">1.</span> <span class="post-toc-text">获取mPackages对象</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#下一步是去哪里来一个LoadedApk放进mPackages中"><span class="post-toc-number">2.</span> <span class="post-toc-text">下一步是去哪里来一个LoadedApk放进mPackages中</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#goto-getPackageInfoNoCheck-…"><span class="post-toc-number">3.</span> <span class="post-toc-text">goto getPackageInfoNoCheck(…)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ApplicationInfo"><span class="post-toc-number">4.</span> <span class="post-toc-text">ApplicationInfo</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#PackageParser"><span class="post-toc-number">5.</span> <span class="post-toc-text">PackageParser</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#goto-generateApplicationInfo"><span class="post-toc-number">6.</span> <span class="post-toc-text">goto generateApplicationInfo</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#execute-getPackageInfoNoCheck-…"><span class="post-toc-number">7.</span> <span class="post-toc-text">execute getPackageInfoNoCheck(…)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#add-LoadedApk-to-ActivityThread-mPackages"><span class="post-toc-number">8.</span> <span class="post-toc-text">add LoadedApk to ActivityThread.mPackages</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#题外话1、为了日后对插件的类的加载作控制，自定义一个ClassLoader"><span class="post-toc-number">9.</span> <span class="post-toc-text">题外话1、为了日后对插件的类的加载作控制，自定义一个ClassLoader</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#题外话2、稳定"><span class="post-toc-number">10.</span> <span class="post-toc-text">题外话2、稳定</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#run"><span class="post-toc-number">11.</span> <span class="post-toc-text">run</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#goto-performLaunchActivity"><span class="post-toc-number">12.</span> <span class="post-toc-text">goto performLaunchActivity</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#hookPackageManager"><span class="post-toc-number">13.</span> <span class="post-toc-text">hookPackageManager()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#激进方案完"><span class="post-toc-number">14.</span> <span class="post-toc-text">激进方案完</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#保守方案-1"><span class="post-toc-number"></span> <span class="post-toc-text">保守方案</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#复习一下private-LoadedApk-getPackageInfo-…"><span class="post-toc-number">1.</span> <span class="post-toc-text">复习一下private LoadedApk getPackageInfo(…)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#goto-LoadedApk-getClassLoader"><span class="post-toc-number">2.</span> <span class="post-toc-text">goto LoadedApk.getClassLoader()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ApplicationLoaders-getDefault-getClassLoader-…"><span class="post-toc-number">3.</span> <span class="post-toc-text">ApplicationLoaders.getDefault().getClassLoader(…)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#PathClassLoader-java"><span class="post-toc-number">4.</span> <span class="post-toc-text">PathClassLoader.java</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#goto-BaseDexClassLoader-findClass-…"><span class="post-toc-number">5.</span> <span class="post-toc-text">goto BaseDexClassLoader.findClass(…)</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#完"><span class="post-toc-number"></span> <span class="post-toc-text">完</span></a>
        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>
    





<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        <!-- Custom Thumbnail -->
        <div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(http://orqt8ndmu.bkt.clouddn.com/material-31.png)">
    
            <p class="article-headline-p">
                Android插件化加载原理
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar2.jpeg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Kelton Chan</strong>
        <span>6月 18, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/class-loader/">class loader</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/hook/">hook</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/plugin/">plugin</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Android插件化加载原理&url=https://channagihong.github.com/2017/06/18/Android插件化加载原理/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Android插件化加载原理&url=https://channagihong.github.com/2017/06/18/Android插件化加载原理/index.html&via=Kelton Chan" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=https://channagihong.github.com/2017/06/18/Android插件化加载原理/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=https://channagihong.github.com/2017/06/18/Android插件化加载原理/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>原文网址：<a href="http://weishu.me/2016/04/05/understand-plugin-framework-classloader/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io" target="_blank" rel="external">http://weishu.me/2016/04/05/understand-plugin-framework-classloader/?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</a></p>
<h3 id="创建Activity类对象的过程"><a href="#创建Activity类对象的过程" class="headerlink" title="创建Activity类对象的过程"></a>创建Activity类对象的过程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">activity = mInstrumentation.newActivity(</div><div class="line">        cl, component.getClassName(), r.intent);</div><div class="line">StrictMode.incrementExpectedActivityCount(activity.getClass());</div><div class="line">r.intent.setExtrasClassLoader(cl);</div></pre></td></tr></table></figure>
<p>这是正常情况下创建Activity类对象的过程(系统通过ClassLoader加载了需要的Activity类并通过反射构造函数创建Activity对象)<br>在插件化中，由于代码存在独立于原进程的文件之中，classLoader不能直接加载。因此必须hook，才能加载。</p>
<h3 id="ClassLoader机制"><a href="#ClassLoader机制" class="headerlink" title="ClassLoader机制"></a>ClassLoader机制</h3><blockquote>
<p>Java虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校检、转换解析和初始化的，最终形成可以被虚拟机直接使用的Java类型，这就是虚拟机的类加载机制。<br>与那些在编译时进行链连接工作的语言不同，在Java语言里面，类型的加载、连接和初始化都是在程序运行期间完成的，这种策略虽然会令类加载时稍微增加一些性能开销，但是会为Java应用程序提供高度的灵活性，Java里天生可以同代拓展的语言特性就是依赖运行期动态加载和动态链接这个特点实现的。例如，如果编写一个面相接口的应用程序，可以等到运行时在制定实际的实现类；用户可以通过Java与定义的和自定义的类加载器，让一个本地的应用程序可以在运行时从网络或其他地方加载一个二进制流作为代码的一部分，这种组装应用程序的方式目前已经广泛应用于Java程序之中。从最基础的Applet，JSP到复杂的OSGi技术，都使用了Java语言运行期类加载的特性。</p>
<h4 id="1、class-to-java"><a href="#1、class-to-java" class="headerlink" title="1、class to java"></a>1、class to java</h4><h4 id="2、on-RunTime"><a href="#2、on-RunTime" class="headerlink" title="2、on RunTime"></a>2、on RunTime</h4><h4 id="3、高度灵活性，如执行刚从网络加载的一个二进制流转换过来的java代码"><a href="#3、高度灵活性，如执行刚从网络加载的一个二进制流转换过来的java代码" class="headerlink" title="3、高度灵活性，如执行刚从网络加载的一个二进制流转换过来的java代码"></a>3、高度灵活性，如执行刚从网络加载的一个二进制流转换过来的java代码</h4></blockquote>
<h3 id="插件化方案"><a href="#插件化方案" class="headerlink" title="插件化方案"></a>插件化方案</h3><p>将插件的dex或者apk文件植入到合适的DexClassLoader，借助这个ClassLoader完成类的加载</p>
<h3 id="ClassLoader入手"><a href="#ClassLoader入手" class="headerlink" title="ClassLoader入手"></a>ClassLoader入手</h3><p>在Activity创建对象过程代码当中可以看到<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div></pre></td></tr></table></figure></p>
<p>而r.packageInfo是一个LoadedApk类的对象。</p>
<h3 id="LoadedApk"><a href="#LoadedApk" class="headerlink" title="LoadedApk"></a>LoadedApk</h3><p>官方文档<br>Local state maintained about a currently loaded apk.<br>就是已经被加载到jvm中的apk文件。<br>一个App程序运行所需的信息，如res、Activity，Service等所有代码都从这个Apk文件获取。</p>
<h3 id="解决了从r-packageInfo再到getClassLoader-的问题，理论上就可以加载插件的代码了"><a href="#解决了从r-packageInfo再到getClassLoader-的问题，理论上就可以加载插件的代码了" class="headerlink" title="解决了从r.packageInfo再到getClassLoader()的问题，理论上就可以加载插件的代码了"></a>解决了从r.packageInfo再到getClassLoader()的问题，理论上就可以加载插件的代码了</h3><h4 id="从performLaunchActivity上溯，辗转到handleLaunchActivity-case-LAUNCH-ACTIVITY，找到r-packageInfo的来源："><a href="#从performLaunchActivity上溯，辗转到handleLaunchActivity-case-LAUNCH-ACTIVITY，找到r-packageInfo的来源：" class="headerlink" title="从performLaunchActivity上溯，辗转到handleLaunchActivity, case LAUNCH_ACTIVITY，找到r.packageInfo的来源："></a>从performLaunchActivity上溯，辗转到handleLaunchActivity, case LAUNCH_ACTIVITY，找到r.packageInfo的来源：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</div><div class="line">r.packageInfo = getPackageInfoNoCheck(</div><div class="line">        r.activityInfo.applicationInfo, r.compatInfo);</div><div class="line">handleLaunchActivity(r, <span class="keyword">null</span>);</div></pre></td></tr></table></figure>
<h4 id="goto-getPackageInfoNoCheck"><a href="#goto-getPackageInfoNoCheck" class="headerlink" title="goto getPackageInfoNoCheck"></a>goto getPackageInfoNoCheck</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> LoadedApk <span class="title">getPackageInfoNoCheck</span><span class="params">(ApplicationInfo ai,</span></span></div><div class="line">        CompatibilityInfo compatInfo) &#123;</div><div class="line">    <span class="keyword">return</span> getPackageInfo(ai, compatInfo, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="goto-getPackageInfo"><a href="#goto-getPackageInfo" class="headerlink" title="goto getPackageInfo"></a>goto getPackageInfo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> LoadedApk <span class="title">getPackageInfo</span><span class="params">(ApplicationInfo aInfo, CompatibilityInfo compatInfo,</span></span></div><div class="line">        ClassLoader baseLoader, <span class="keyword">boolean</span> securityViolation, <span class="keyword">boolean</span> includeCode,</div><div class="line">        <span class="keyword">boolean</span> registerPackage) &#123;</div><div class="line">        <span class="comment">// 获取userid信息</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> differentUser = (UserHandle.myUserId() != UserHandle.getUserId(aInfo.uid));</div><div class="line">        <span class="keyword">synchronized</span> (mResourcesManager) &#123;</div><div class="line">        <span class="comment">// 尝试获取缓存信息</span></div><div class="line">        WeakReference&lt;LoadedApk&gt; ref;</div><div class="line">        <span class="keyword">if</span> (differentUser) &#123;</div><div class="line">            <span class="comment">// Caching not supported across users</span></div><div class="line">            ref = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (includeCode) &#123;</div><div class="line">            <span class="comment">//if not differentUser, sharing codes and resources</span></div><div class="line">            ref = mPackages.get(aInfo.packageName);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//if not differentUser, sharing resources only</span></div><div class="line">            ref = mResourcePackages.get(aInfo.packageName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        LoadedApk packageInfo = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span> || (packageInfo.mResources != <span class="keyword">null</span></div><div class="line">                &amp;&amp; !packageInfo.mResources.getAssets().isUpToDate())) &#123;</div><div class="line">                <span class="comment">// 缓存没有命中，直接new</span></div><div class="line">            packageInfo =</div><div class="line">                <span class="keyword">new</span> LoadedApk(<span class="keyword">this</span>, aInfo, compatInfo, baseLoader,</div><div class="line">                        securityViolation, includeCode &amp;&amp;</div><div class="line">                        (aInfo.flags&amp;ApplicationInfo.FLAG_HAS_CODE) != <span class="number">0</span>, registerPackage);</div><div class="line"></div><div class="line">        <span class="comment">// 省略。。更新缓存</span></div><div class="line">        <span class="keyword">return</span> packageInfo;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="由此可见，可有两个方案"><a href="#由此可见，可有两个方案" class="headerlink" title="由此可见，可有两个方案"></a>由此可见，可有两个方案</h3><h5 id="激进方案"><a href="#激进方案" class="headerlink" title="激进方案"></a>激进方案</h5><p>通过将LoadedApk放进缓存的map中，是的在activity实例化的时候，getPackageInfo能够正常运作，返回插件的LoadedApk，然后得到插件的classLoader，从而能够将插件的类加载到JVM中，JVM正常反射就能new Activity对象。</p>
<h5 id="保守方案"><a href="#保守方案" class="headerlink" title="保守方案"></a>保守方案</h5><p>通过将插件中的类写进主App的classLoader中，使用实例化activity的时候就算传入主App的classLoader也能将插件中的类加载进JVM，从而JVM能够通过反射new Activity对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div></pre></td></tr></table></figure></p>
<p>就可以创建插件Activity对象了</p>
<h2 id="激进方案，通过LoadedApk放进缓存中，插件中的actiivty对象就能被创建了"><a href="#激进方案，通过LoadedApk放进缓存中，插件中的actiivty对象就能被创建了" class="headerlink" title="激进方案，通过LoadedApk放进缓存中，插件中的actiivty对象就能被创建了"></a>激进方案，通过LoadedApk放进缓存中，插件中的actiivty对象就能被创建了</h2><h3 id="获取mPackages对象"><a href="#获取mPackages对象" class="headerlink" title="获取mPackages对象"></a>获取mPackages对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 先获取到当前的ActivityThread对象</span></div><div class="line">Class&lt;?&gt; activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</div><div class="line">Method currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</div><div class="line">currentActivityThreadMethod.setAccessible(<span class="keyword">true</span>);</div><div class="line">Object currentActivityThread = currentActivityThreadMethod.invoke(<span class="keyword">null</span>);</div><div class="line"></div><div class="line"><span class="comment">// 获取到 mPackages 这个静态成员变量, 这里缓存了dex包的信息</span></div><div class="line">Field mPackagesField = activityThreadClass.getDeclaredField(<span class="string">"mPackages"</span>);</div><div class="line">mPackagesField.setAccessible(<span class="keyword">true</span>);</div><div class="line">Map mPackages = (Map) mPackagesField.get(currentActivityThread);</div></pre></td></tr></table></figure>
<h3 id="下一步是去哪里来一个LoadedApk放进mPackages中"><a href="#下一步是去哪里来一个LoadedApk放进mPackages中" class="headerlink" title="下一步是去哪里来一个LoadedApk放进mPackages中"></a>下一步是去哪里来一个LoadedApk放进mPackages中</h3><p>从上面可知，private LoadedApk getPackageInfo(…)会自动用系统的方式去生成一个LoadedApk，但由于是private函数，所以Google在改动的时候丝毫不用担心会影响到用户，考虑到日后的兼容性，放弃直接调用的方案<br>间接调用这个private LoadedApk getPackageInfo(…)的public函数有两个，<br>分别是<br>public LoadedApk getPackageInfo(…)<br>public LoadedApk getPackageInfoNoCheck(…)<br>从函数名称上可以看出，前者需要作一些验证，但两个函数都能拿到LoadedApk，所以选择后者。</p>
<h3 id="goto-getPackageInfoNoCheck-…"><a href="#goto-getPackageInfoNoCheck-…" class="headerlink" title="goto getPackageInfoNoCheck(…)"></a>goto getPackageInfoNoCheck(…)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> LoadedApk <span class="title">getPackageInfoNoCheck</span><span class="params">(ApplicationInfo ai,</span></span></div><div class="line">            CompatibilityInfo compatInfo) &#123;&#125;</div></pre></td></tr></table></figure>
<p>getPackageInfoNoCheck(..)需要两个参数，<br>1、ApplicationInfo<br>2、CompatibilityInfo，<br>由于目前我们只关心调用该函数，兼容性问题可以暂搁一边，第二个参数输入CompatibilityInfo.DEFAULT_COMPATIBILITY_INFO。<br>然后目前剩下的就ApplicationInfo了</p>
<h3 id="ApplicationInfo"><a href="#ApplicationInfo" class="headerlink" title="ApplicationInfo"></a>ApplicationInfo</h3><p>Information you can retrieve about a particular application. This corresponds to information collected from the AndroidManifest.xml’s <application> tag.<br>所以ApplicationInfo是从AndroidManifest.xml中解析出来的数据结构<br>两者的关系就像是一个是方便人类识别的文档，一个是方便系统识别的文档。<br>而从AndroidManifest.xml到ApplicationInfo，中间需要parser – PackageParser。</application></p>
<h3 id="PackageParser"><a href="#PackageParser" class="headerlink" title="PackageParser"></a>PackageParser</h3><p>由于基本上Android每个版本上的PackageParser都被Google改动，所以PackageParser兼容性很差，所以基本上每个版本要调用不同的PackageParser去解析AndroidManifest.xml。<br>以API23为例，<br>PackageParser有一个方法,generateApplication<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationInfo <span class="title">generateApplicationInfo</span><span class="params">(Package p, <span class="keyword">int</span> flags,</span></span></div><div class="line">   PackageUserState state)&#123;&#125;</div></pre></td></tr></table></figure></p>
<p>以下是调用generateApplicationInfo的反射代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; packageParserClass = Class.forName(<span class="string">"android.content.pm.PackageParser"</span>);</div><div class="line"><span class="comment">// 首先拿到我们得终极目标: generateApplicationInfo方法</span></div><div class="line"><span class="comment">// API 23 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div><div class="line"><span class="comment">// public static ApplicationInfo generateApplicationInfo(Package p, int flags,</span></div><div class="line"><span class="comment">//    PackageUserState state) &#123;</span></div><div class="line"><span class="comment">// 其他Android版本不保证也是如此.</span></div><div class="line">Class&lt;?&gt; packageParser$PackageClass = Class.forName(<span class="string">"android.content.pm.PackageParser$Package"</span>);</div><div class="line">Class&lt;?&gt; packageUserStateClass = Class.forName(<span class="string">"android.content.pm.PackageUserState"</span>);</div><div class="line">Method generateApplicationInfoMethod = packageParserClass.getDeclaredMethod(<span class="string">"generateApplicationInfo"</span>,</div><div class="line">        packageParser$PackageClass,</div><div class="line">        <span class="keyword">int</span>.class,</div><div class="line">                packageUserStateClass);</div></pre></td></tr></table></figure></p>
<h3 id="goto-generateApplicationInfo"><a href="#goto-generateApplicationInfo" class="headerlink" title="goto generateApplicationInfo"></a>goto generateApplicationInfo</h3><p>该函数有3个参数：<br>1、Package<br>2、Integer<br>3、PackageUserState</p>
<p>1、PackageParser.Package<br>Representation of a full package parsed from APK files on disk. A package consists of a single base APK, and zero or more split APKs.<br>代表的是被解析后的apk信息，就是通过PackageParser.parsePackage去解析得到apk信息</p>
<p>1.1、PackageParser.parserPackage<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 首先, 我们得创建出一个Package对象出来供这个方法调用</span></div><div class="line"><span class="comment">// 而这个需要得对象可以通过 android.content.pm.PackageParser#parsePackage 这个方法返回得 Package对象得字段获取得到</span></div><div class="line"><span class="comment">// 创建出一个PackageParser对象供使用</span></div><div class="line">Object packageParser = packageParserClass.newInstance();</div><div class="line"><span class="comment">// 调用 PackageParser.parsePackage 解析apk的信息</span></div><div class="line">Method parsePackageMethod = packageParserClass.getDeclaredMethod(<span class="string">"parsePackage"</span>, File.class, <span class="keyword">int</span>.class);</div><div class="line"></div><div class="line"><span class="comment">// 实际上是一个 android.content.pm.PackageParser.Package 对象</span></div><div class="line">Object packageObj = parsePackageMethod.invoke(packageParser, apkFile, <span class="number">0</span>);</div></pre></td></tr></table></figure></p>
<p>反射调用之后，就会得到第一个参数package</p>
<p>2、Integer<br>由于我们解析整个apk包，这里传0</p>
<p>3、PackageUserState<br>PackageUserState代表的是不同用户中的信息，Android是一个多用户多任务系统。<br>这里只需要默认即可<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Object defaultPackageUserState = packageUserStateClass.newInstance();</div></pre></td></tr></table></figure></p>
<p>至此，generateApplicationInfo的三个参数已准备好<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ApplicationInfo applicationInfo = (ApplicationInfo) generateApplicationInfoMethod.invoke(packageParser,</div><div class="line">        packageObj, <span class="number">0</span>, defaultPackageUserState);</div><div class="line"><span class="comment">//由于系统调用的generateApplicationInfo得到的ApplicationInfo并没有apk文件本身的信息，所以要设置下，建立目标apk与这个ApplicationInfo对象的关联。</span></div><div class="line">String apkPath = apkFile.getPath();</div><div class="line">applicationInfo.sourceDir = apkPath;</div><div class="line">applicationInfo.publicSourceDir = apkPath;</div></pre></td></tr></table></figure></p>
<h3 id="execute-getPackageInfoNoCheck-…"><a href="#execute-getPackageInfoNoCheck-…" class="headerlink" title="execute getPackageInfoNoCheck(…)"></a>execute getPackageInfoNoCheck(…)</h3><p>由于getPackageInfoNoCheck(…)的入参已得到，直接调用即可获得LoadedApk<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// android.content.res.CompatibilityInfo</span></div><div class="line">Class&lt;?&gt; compatibilityInfoClass = Class.forName(<span class="string">"android.content.res.CompatibilityInfo"</span>);</div><div class="line">Method getPackageInfoNoCheckMethod = activityThreadClass.getDeclaredMethod(<span class="string">"getPackageInfoNoCheck"</span>, ApplicationInfo.class, compatibilityInfoClass);</div><div class="line"></div><div class="line">Field defaultCompatibilityInfoField = compatibilityInfoClass.getDeclaredField(<span class="string">"DEFAULT_COMPATIBILITY_INFO"</span>);</div><div class="line">defaultCompatibilityInfoField.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">Object defaultCompatibilityInfo = defaultCompatibilityInfoField.get(<span class="keyword">null</span>);</div><div class="line">ApplicationInfo applicationInfo = generateApplicationInfo(apkFile);</div><div class="line"></div><div class="line">Object loadedApk = getPackageInfoNoCheckMethod.invoke(currentActivityThread, applicationInfo, defaultCompatibilityInfo);</div></pre></td></tr></table></figure></p>
<h3 id="add-LoadedApk-to-ActivityThread-mPackages"><a href="#add-LoadedApk-to-ActivityThread-mPackages" class="headerlink" title="add LoadedApk to ActivityThread.mPackages"></a>add LoadedApk to ActivityThread.mPackages</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mPackages.put(applicationInfo.packageName, loadedApk);</div></pre></td></tr></table></figure>
<h3 id="题外话1、为了日后对插件的类的加载作控制，自定义一个ClassLoader"><a href="#题外话1、为了日后对插件的类的加载作控制，自定义一个ClassLoader" class="headerlink" title="题外话1、为了日后对插件的类的加载作控制，自定义一个ClassLoader"></a>题外话1、为了日后对插件的类的加载作控制，自定义一个ClassLoader</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomClassLoader</span> <span class="keyword">extends</span> <span class="title">DexClassLoader</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomClassLoader</span><span class="params">(String dexPath, String optimizedDirectory, String libraryPath, ClassLoader parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(dexPath, optimizedDirectory, libraryPath, parent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>目前只需要这样即可，不需要作任何额外处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">String odexPath = Utils.getPluginOptDexDir(applicationInfo.packageName).getPath();</div><div class="line">String libDir = Utils.getPluginLibDir(applicationInfo.packageName).getPath();</div><div class="line">ClassLoader classLoader = <span class="keyword">new</span> CustomClassLoader(apkFile.getPath(), odexPath, libDir, ClassLoader.getSystemClassLoader());</div><div class="line">Field mClassLoaderField = loadedApk.getClass().getDeclaredField(<span class="string">"mClassLoader"</span>);</div><div class="line">mClassLoaderField.setAccessible(<span class="keyword">true</span>);</div><div class="line">mClassLoaderField.set(loadedApk, classLoader);</div></pre></td></tr></table></figure></p>
<p>替换loadedApk中的ClassLoader</p>
<h3 id="题外话2、稳定"><a href="#题外话2、稳定" class="headerlink" title="题外话2、稳定"></a>题外话2、稳定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 由于是弱引用, 因此我们必须在某个地方存一份, 不然容易被GC; 那么就前功尽弃了.</span></div><div class="line">sLoadedApk.put(applicationInfo.packageName, loadedApk);</div><div class="line">WeakReference weakReference = <span class="keyword">new</span> WeakReference(loadedApk);</div><div class="line">mPackages.put(applicationInfo.packageName, weakReference);</div></pre></td></tr></table></figure>
<h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><p>运行时报错了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">04</span>-<span class="number">05</span> <span class="number">02</span>:<span class="number">49</span>:<span class="number">53.742</span>  <span class="number">11759</span>-<span class="number">11759</span>/com.weishu.upf.hook_classloader E/AndroidRuntime﹕ FATAL EXCEPTION: main</div><div class="line">    Process: com.weishu.upf.hook_classloader, PID: <span class="number">11759</span></div><div class="line">    java.lang.RuntimeException: Unable to start activity ComponentInfo&#123;com.weishu.upf.ams_pms_hook.app/com.weishu.upf.ams_pms_hook.app.MainActivity&#125;: java.lang.RuntimeException: Unable to instantiate application android.app.Application: java.lang.IllegalStateException: Unable to get <span class="keyword">package</span> info <span class="keyword">for</span> com.weishu.upf.ams_pms_hook.app; is <span class="keyword">package</span> not installed?</div></pre></td></tr></table></figure></p>
<p>无法实例化application，由于插件未安装。<br>而application的实例化，代码也在performLaunchActivity中</p>
<h3 id="goto-performLaunchActivity"><a href="#goto-performLaunchActivity" class="headerlink" title="goto performLaunchActivity"></a>goto performLaunchActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    java.lang.ClassLoader cl = getClassLoader();</div><div class="line">    <span class="keyword">if</span> (!mPackageName.equals(<span class="string">"android"</span>)) &#123;</div><div class="line">        initializeJavaContextClassLoader();</div><div class="line">    &#125;</div><div class="line">    ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</div><div class="line">    app = mActivityThread.mInstrumentation.newApplication(</div><div class="line">            cl, appClass, appContext);</div><div class="line">    appContext.setOuterContext(app);</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    <span class="keyword">if</span> (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">            <span class="string">"Unable to instantiate application "</span> + appClass</div><div class="line">            + <span class="string">": "</span> + e.toString(), e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里只能一行行代码检查了<br>1、getClassLoader()<br>该函数中没有throw任何错误，跳过<br>2、initializeJavaContextClassLoader();<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeJavaContextClassLoader</span><span class="params">()</span> </span>&#123;</div><div class="line">    IPackageManager pm = ActivityThread.getPackageManager();</div><div class="line">    android.content.pm.PackageInfo pi;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        pi = pm.getPackageInfo(mPackageName, <span class="number">0</span>, UserHandle.myUserId());</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unable to get package info for "</span></div><div class="line">                + mPackageName + <span class="string">"; is system dying?"</span>, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (pi == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unable to get package info for "</span></div><div class="line">                + mPackageName + <span class="string">"; is package not installed?"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> sharedUserIdSet = (pi.sharedUserId != <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">boolean</span> processNameNotDefault =</div><div class="line">        (pi.applicationInfo != <span class="keyword">null</span> &amp;&amp;</div><div class="line">         !mPackageName.equals(pi.applicationInfo.processName));</div><div class="line">    <span class="keyword">boolean</span> sharable = (sharedUserIdSet || processNameNotDefault);</div><div class="line">    ClassLoader contextClassLoader =</div><div class="line">        (sharable)</div><div class="line">        ? <span class="keyword">new</span> WarningContextClassLoader()</div><div class="line">        : mClassLoader;</div><div class="line">    Thread.currentThread().setContextClassLoader(contextClassLoader);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于pm.getPackageInfo(…)返回null，所以throw IllegalStateException。<br>就是这么任性，走都走到这里，真的不回头</p>
<h3 id="hookPackageManager"><a href="#hookPackageManager" class="headerlink" title="hookPackageManager()"></a>hookPackageManager()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hookPackageManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 这一步是因为 initializeJavaContextClassLoader 这个方法内部无意中检查了这个包是否在系统安装</span></div><div class="line">    <span class="comment">// 如果没有安装, 直接抛出异常, 这里需要临时Hook掉 PMS, 绕过这个检查.</span></div><div class="line"></div><div class="line">    Class&lt;?&gt; activityThreadClass = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</div><div class="line">    Method currentActivityThreadMethod = activityThreadClass.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</div><div class="line">    currentActivityThreadMethod.setAccessible(<span class="keyword">true</span>);</div><div class="line">    Object currentActivityThread = currentActivityThreadMethod.invoke(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 获取ActivityThread里面原始的 sPackageManager</span></div><div class="line">    Field sPackageManagerField = activityThreadClass.getDeclaredField(<span class="string">"sPackageManager"</span>);</div><div class="line">    sPackageManagerField.setAccessible(<span class="keyword">true</span>);</div><div class="line">    Object sPackageManager = sPackageManagerField.get(currentActivityThread);</div><div class="line"></div><div class="line">    <span class="comment">// 准备好代理对象, 用来替换原始的对象</span></div><div class="line">    Class&lt;?&gt; iPackageManagerInterface = Class.forName(<span class="string">"android.content.pm.IPackageManager"</span>);</div><div class="line">    Object proxy = Proxy.newProxyInstance(iPackageManagerInterface.getClassLoader(),</div><div class="line">            <span class="keyword">new</span> Class&lt;?&gt;[] &#123; iPackageManagerInterface &#125;,</div><div class="line">            <span class="keyword">new</span> IPackageManagerHookHandler(sPackageManager));</div><div class="line"></div><div class="line">    <span class="comment">// 1. 替换掉ActivityThread里面的 sPackageManager 字段</span></div><div class="line">    sPackageManagerField.set(currentActivityThread, proxy);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里真的不懂啊，膝盖碎了一地，有机会再了解hook.</p>
<h3 id="激进方案完"><a href="#激进方案完" class="headerlink" title="激进方案完"></a>激进方案完</h3><h2 id="保守方案-1"><a href="#保守方案-1" class="headerlink" title="保守方案"></a>保守方案</h2><h3 id="复习一下private-LoadedApk-getPackageInfo-…"><a href="#复习一下private-LoadedApk-getPackageInfo-…" class="headerlink" title="复习一下private LoadedApk getPackageInfo(…)"></a>复习一下private LoadedApk getPackageInfo(…)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> LoadedApk <span class="title">getPackageInfo</span><span class="params">(ApplicationInfo aInfo, CompatibilityInfo compatInfo,</span></span></div><div class="line">        ClassLoader baseLoader, <span class="keyword">boolean</span> securityViolation, <span class="keyword">boolean</span> includeCode,</div><div class="line">        <span class="keyword">boolean</span> registerPackage) &#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> differentUser = (UserHandle.myUserId() != UserHandle.getUserId(aInfo.uid));</div><div class="line">    <span class="keyword">synchronized</span> (mResourcesManager) &#123;</div><div class="line">        WeakReference&lt;LoadedApk&gt; ref;</div><div class="line">        <span class="keyword">if</span> (differentUser) &#123;</div><div class="line">            <span class="comment">// Caching not supported across users</span></div><div class="line">            ref = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (includeCode) &#123;</div><div class="line">            ref = mPackages.get(aInfo.packageName);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ref = mResourcePackages.get(aInfo.packageName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        LoadedApk packageInfo = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span> || (packageInfo.mResources != <span class="keyword">null</span></div><div class="line">                &amp;&amp; !packageInfo.mResources.getAssets().isUpToDate())) &#123;</div><div class="line">            packageInfo =</div><div class="line">                <span class="keyword">new</span> LoadedApk(<span class="keyword">this</span>, aInfo, compatInfo, baseLoader,</div><div class="line">                        securityViolation, includeCode &amp;&amp;</div><div class="line">                        (aInfo.flags&amp;ApplicationInfo.FLAG_HAS_CODE) != <span class="number">0</span>, registerPackage);</div><div class="line"></div><div class="line">            <span class="comment">// 略</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>保守方案：<br>假设我们什么都不改动，调用插件的activity进行实例化的时候，getPackageInfo()会返回new LoadedApk(…).<br>此处再次引用activity实例化的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</div><div class="line">StrictMode.incrementExpectedActivityCount(activity.getClass());</div><div class="line">r.intent.setExtrasClassLoader(cl);</div></pre></td></tr></table></figure></p>
<p>可以看出，通过LoadedApk的getClassLoader()去获取类加载器，然后classLoader将目标类加载进JVM,最后通过反射新建了这个activity对象。<br>这时候问题就来了，我们的插件的类没有进行安装，没有出现在主APP的AndroidManifest.xml(ApplicationInfo)中，所以加载不到插件的类进来。<br>由于主角自带光环，所以轻易看出怎么样才可以让主App的classLoader能够加载没有在主LoadedApk中的类。<br>首先，主角告诉我们，<br>主LoadedApk所拥有的classLoader是通过系统的getClassLoader()得到的。</p>
<h3 id="goto-LoadedApk-getClassLoader"><a href="#goto-LoadedApk-getClassLoader" class="headerlink" title="goto LoadedApk.getClassLoader()"></a>goto LoadedApk.getClassLoader()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mClassLoader != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> mClassLoader;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mIncludeCode &amp;&amp; !mPackageName.equals(<span class="string">"android"</span>)) &#123;</div><div class="line">            <span class="comment">// 略...</span></div><div class="line">            mClassLoader = ApplicationLoaders.getDefault().getClassLoader(zip, lib,</div><div class="line">                    mBaseClassLoader);</div><div class="line"></div><div class="line">            StrictMode.setThreadPolicy(oldPolicy);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mBaseClassLoader == <span class="keyword">null</span>) &#123;</div><div class="line">                mClassLoader = ClassLoader.getSystemClassLoader();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mClassLoader = mBaseClassLoader;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mClassLoader;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有两个ClassLoader，<br>一个是系统的，一个是主App的。<br>getSystemClassLoader()，系统级别的classLoader，不是不能加载未安装的类，是牵涉的太多了。<br>一只鸡，一头牛，能杀其一就可以通关，你挑哪个？<br>所以，目标是ApplicationLoaders.getDefault().getClassLoader();</p>
<h3 id="ApplicationLoaders-getDefault-getClassLoader-…"><a href="#ApplicationLoaders-getDefault-getClassLoader-…" class="headerlink" title="ApplicationLoaders.getDefault().getClassLoader(…)"></a>ApplicationLoaders.getDefault().getClassLoader(…)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getClassLoader</span><span class="params">(String zip, String libPath, ClassLoader parent)</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    ClassLoader baseParent = ClassLoader.getSystemClassLoader().getParent();</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (mLoaders) &#123;</div><div class="line">        <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</div><div class="line">            parent = baseParent;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (parent == baseParent) &#123;</div><div class="line">            ClassLoader loader = mLoaders.get(zip);</div><div class="line">            <span class="keyword">if</span> (loader != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> loader;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, zip);</div><div class="line">            PathClassLoader pathClassloader =</div><div class="line">                <span class="keyword">new</span> PathClassLoader(zip, libPath, parent);</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line"></div><div class="line">            mLoaders.put(zip, pathClassloader);</div><div class="line">            <span class="keyword">return</span> pathClassloader;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, zip);</div><div class="line">        PathClassLoader pathClassloader = <span class="keyword">new</span> PathClassLoader(zip, parent);</div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">        <span class="keyword">return</span> pathClassloader;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到classLoader都是PathClassLoader的实例。</p>
<h3 id="PathClassLoader-java"><a href="#PathClassLoader-java" class="headerlink" title="PathClassLoader.java"></a>PathClassLoader.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, ClassLoader parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>((String)<span class="keyword">null</span>, (File)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (ClassLoader)<span class="keyword">null</span>);</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathClassLoader</span><span class="params">(String dexPath, String libraryPath, ClassLoader parent)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>((String)<span class="keyword">null</span>, (File)<span class="keyword">null</span>, (String)<span class="keyword">null</span>, (ClassLoader)<span class="keyword">null</span>);</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Stub!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>继续向BaseDexClassLoader出发<br>BaseDexClassLoader中，主角看到，与classLoader相关的就只有defineClass与findClass方法。<br>然后主角确定与findClass有关</p>
<h3 id="goto-BaseDexClassLoader-findClass-…"><a href="#goto-BaseDexClassLoader-findClass-…" class="headerlink" title="goto BaseDexClassLoader.findClass(…)"></a>goto BaseDexClassLoader.findClass(…)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Class <span class="title">findClass</span><span class="params">(String name, List&lt;Throwable&gt; suppressed)</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span> (Element element : dexElements) &#123;</div><div class="line">       DexFile dex = element.dexFile;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (dex != <span class="keyword">null</span>) &#123;</div><div class="line">           Class clazz = dex.loadClassBinaryName(name, definingContext, suppressed);</div><div class="line">           <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">return</span> clazz;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (dexElementsSuppressedExceptions != <span class="keyword">null</span>) &#123;</div><div class="line">       suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到findClass最后都是通过寻找二进制文件将类加载进JVM，我们只需要将插件的dex放到dexElements中即可。<br>这样主App的classLoader在遍历dexElements的时候就能找到插件的类，然后加载进JVM。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">patchClassLoader</span><span class="params">(ClassLoader cl, File apkFile, File optDexFile)</span></span></div><div class="line">        <span class="keyword">throws</span> IllegalAccessException, NoSuchMethodException, IOException, InvocationTargetException, InstantiationException, NoSuchFieldException &#123;</div><div class="line">    <span class="comment">// 获取 BaseDexClassLoader : pathList</span></div><div class="line">    Field pathListField = DexClassLoader.class.getSuperclass().getDeclaredField(<span class="string">"pathList"</span>);</div><div class="line">    pathListField.setAccessible(<span class="keyword">true</span>);</div><div class="line">    Object pathListObj = pathListField.get(cl);</div><div class="line"></div><div class="line">    <span class="comment">// 获取 PathList: Element[] dexElements</span></div><div class="line">    Field dexElementArray = pathListObj.getClass().getDeclaredField(<span class="string">"dexElements"</span>);</div><div class="line">    dexElementArray.setAccessible(<span class="keyword">true</span>);</div><div class="line">    Object[] dexElements = (Object[]) dexElementArray.get(pathListObj);</div><div class="line"></div><div class="line">    <span class="comment">// Element 类型</span></div><div class="line">    Class&lt;?&gt; elementClass = dexElements.getClass().getComponentType();</div><div class="line"></div><div class="line">    <span class="comment">// 创建一个数组, 用来替换原始的数组</span></div><div class="line">    Object[] newElements = (Object[]) Array.newInstance(elementClass, dexElements.length + <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 构造插件Element(File file, boolean isDirectory, File zip, DexFile dexFile) 这个构造函数</span></div><div class="line">    Constructor&lt;?&gt; constructor = elementClass.getConstructor(File.class, <span class="keyword">boolean</span>.class, File.class, DexFile.class);</div><div class="line">    Object o = constructor.newInstance(apkFile, <span class="keyword">false</span>, apkFile, DexFile.loadDex(apkFile.getCanonicalPath(), optDexFile.getAbsolutePath(), <span class="number">0</span>));</div><div class="line"></div><div class="line">    Object[] toAddElementArray = <span class="keyword">new</span> Object[] &#123; o &#125;;</div><div class="line">    <span class="comment">// 把原始的elements复制进去</span></div><div class="line">    System.arraycopy(dexElements, <span class="number">0</span>, newElements, <span class="number">0</span>, dexElements.length);</div><div class="line">    <span class="comment">// 插件的那个element复制进去</span></div><div class="line">    System.arraycopy(toAddElementArray, <span class="number">0</span>, newElements, dexElements.length, toAddElementArray.length);</div><div class="line"></div><div class="line">    <span class="comment">// 替换</span></div><div class="line">    dexElementArray.set(pathListObj, newElements);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="完"><a href="#完" class="headerlink" title="完"></a>完</h2>
    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/06/18/Apk文件相关/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/06/18/SuperSu初体验/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/home.jpeg);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar2.jpeg" alt="Kelton Chan's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        channagihong@outlook.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">5</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Android-notes/">Android notes<span class="sidebar_archives-count">5</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="Tags">
                
                    <i class="material-icons sidebar-material-icons">loyalty</i>
                
                Tags
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">5</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-facebook">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Kelton Chan
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->


    <script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==")</script>
    <script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script>



    <script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Window Load-->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Bing Background -->


<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
